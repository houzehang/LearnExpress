<form id="myinfoform" class="form-horizontal">
<fieldset>

<!-- Form Name -->
<legend>我的信息</legend>

<!-- Text input-->
<div class="control-group">
  <label class="control-label" for="schoolname">我的学校</label>
  <div class="controls">
    <input id="schoolname" name="schoolname" type="text" placeholder="点击选择" class="input-xlarge" required="">
    
  </div>
</div>

<!-- Text input-->
<div class="control-group">
  <label class="control-label" for="address">宿舍楼及门牌号</label>
  <div class="controls">
    <input id="address" name="address" type="text" placeholder="如：男生宿舍2号楼1001" class="input-xlarge" required="">
    <p class="help-block">方便下单后送货上门，或开店后学生上门购买</p>
  </div>
</div>

<!-- Text input-->
<div class="control-group">
  <label class="control-label" for="nickname">称呼</label>
  <div class="controls">
    <input id="nickname" name="nickname" type="text" placeholder="如：小李、宿舍长、宿舍里最帅的人" class="input-xlarge" required="">
    
  </div>
</div>

<!-- Text input-->
<div class="control-group">
  <label class="control-label" for="tel">手机号</label>
  <div class="controls">
    <input id="tel" name="tel" type="text" placeholder="" class="input-xlarge" required="">
    
  </div>
</div>

<!-- Button (Double) -->
<div class="control-group">
  <label class="control-label" for="btn_save"></label>
  <div class="controls">
    <button id="btn_save" name="btn_save" class="btn btn-success" disabled="true">保存</button>
    <button id="btn_abort" name="btn_abort" class="btn btn-danger" style="display: none;">取消</button>
  </div>
</div>

</fieldset>
</form>

<script type="text/javascript">
$(function(){
  ////======== 最初数据 ========
  var orgSid = '{{sid}}';
  var orgTel = '{{tel}}';
  var orgAdress = '{{address}}';
  var orgName = '{{name}}';
  function checkChanged(){
    if (orgSid != mySchoolId || orgTel != $('#tel').val() || orgAdress != $('#address').val() || orgName != $('#nickname').val()) {
      $('#btn_save').removeAttr("disabled"); 
      $('#btn_abort').show(); 

    }else{
      $('#btn_save').attr("disabled","disabled"); 
      $('#btn_abort').hide(); 
    }
  }
  ////======== 选择学校 ========
  var mySchoolId = '{{sid}}';
  var mySchoolName = null;
  $('#schoolname').click(function() {
    showSchools(function(schoolId, schoolName) {
      mySchoolId = schoolId;
      mySchoolName = schoolName;
      $("#schoolname").val(schoolName);
      checkChanged();
    });
  });
  $("#schoolname").bind('input propertychange', function() {
    $("#schoolname").val(mySchoolName ? mySchoolName : '');
    checkChanged();
  });
  $("#address").bind('input propertychange', function() {
    checkChanged();
  });
  $("#nickname").bind('input propertychange', function() {
    checkChanged();
  });
  $("#tel").bind('input propertychange', function() {
    checkChanged();
  });

  function onSaveSuccess(){
    orgSid = mySchoolId;
    orgTel = $('#tel').val();
    orgAdress = $('#address').val();
    orgName = $('#nickname').val();
    checkChanged();
  };

  ////======== 保存 ========
  $('#btn_save').click(function() {
    window.event.returnValue = false;
    ////======== 表单验证 ========
    var name = $('#nickname').val();
    var address = $('#address').val();
    var tel = $('#tel').val();
    if (!mySchoolId) {
      alert('请选择学校');
      return;
    } else if (!name || name.length == 0) {
      alert('称呼不可为空');
      return;
    } else if (!(/^1[3|4|5|8][0-9]\d{4,8}$/.test(tel) && tel.length == 11)) {
      alert('手机号码格式错误');
      return;
    }

    $.post('createStudent', {
      name: name,
      sid: mySchoolId,
      tel: tel,
      address: address
    }, function(data) {
      if (data.ok) {
        alert('保存成功');
        onSaveSuccess();
      } else {
        alert('保存失败');
      }
    })
  });
  ////======== 取消保存 ========
  $('#btn_abort').click(function() {
    window.event.returnValue = false;
    mySchoolId = orgSid;
    $('#schoolname').val(getSchoolNameBySid(orgSid));
    $('#tel').val(orgTel);
    $('#address').val(orgAdress);
    $('#nickname').val(orgName);
    checkChanged();
  });

  ////======== 初始化数据 ========
  $('#schoolname').val(getSchoolNameBySid(mySchoolId));
  $('#tel').val('{{tel}}');
  $('#address').val('{{address}}');
  $('#nickname').val('{{name}}');
});
</script>